# Import psPAS Module
Import-Module psPAS

# Prompt user for CyberArk credentials
$UPCred = Get-Credential

# Get header authentication (PCLOUD Admins Only)
$header = Get-IdentityHeader -IdentityTenantURL "aat4012.id.cyberark.cloud" -psPASFormat -PCloudSubdomain "cna-prod" -UPCreds $UPCred

# Register to use header credentials for PAS session
Use-PASSession $header

# Fetch all safes
$PSSafes = Get-PASSafe

# Define CSV export path
$exportPath = "E:\Installation Media\RemovePendingAccount\PSSafes.csv"

# Select required fields and export to CSV
$PSSafes | Select-Object safeUrlId, safeName, safeNumber, description, location, `
    @{Name="creator_id"; Expression={$_.creator.id}}, `
    @{Name="creator_name"; Expression={$_.creator.name}}, `
    olacEnabled, managingCPM, numberOfVersionsRetention, numberOfDaysRetention, `
    autoPurgeEnabled, creationTime, lastModificationTime, isExpiredMember |
Export-Csv -Path $exportPath -NoTypeInformation

# Output completion message
Write-Output "CyberArk Safes have been exported to: $exportPath"
